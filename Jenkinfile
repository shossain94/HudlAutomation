pipeline {
	agent any {
			stages {
				stage('Install Dependencies')	{
					steps {
						sh 'sudo npm cache clean -f'
						sh 'sudo npm install'
						sh 'sudo npm install wdio-allure-reporter --save-dev'
						sh 'sudo npm install -g allure-commandline --save-dev'
						sh 'sudo docker pull elgalu/selenium'
						sh 'sudo docker pull dosel/zalenium'
						sh 'sudo docker pull maven'
						}
					}
				stage('Start Zalenium') {
						script {
								try {
									sh 'docker run --rm -it --name zalenium -p 4444:4444 -v /var/run/docker.sock:/var/run/docker.sock -v /tmp/videos:/home/seluser/videos -e WAIT_FOR_AVAILABLE_NODES=false --privileged dosel/zalenium start --desiredContainers 4'
									}
									catch(err)	{
									echo err.getMessage()
									}
								}
							}
						}
				stage('Run Tests') {
					agent {
						docker {
							image 'maven'
							}
						}
						steps {
							sh 'mvn clean verify serenity:aggregate'
							}
						}
				stage('Generating Allure Reports') {
					steps {
						allure([
						includeProperties: false,
						jdk: '',
						properties: [],
						reportBuildPolicy: 'ALWAYS',
						results: [[path: 'allure-results']]
						])
					}
				}
				stage('Stop Zalenium')	{
					steps {
						sh'docker stop zalenium'
						}
					}
				}
			}							